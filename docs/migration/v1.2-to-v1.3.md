# Migration from v1.2.0 to v1.3.0

This guide helps you upgrade from AstroSDK v1.2.0 to v1.3.0.

## Overview of Changes

v1.3.0 introduces significant architectural improvements:

- **Pydantic v2 Migration**: All domain models are now immutable BaseModels
- **Public Facade API**: Clean `__init__.py` with user-friendly functions
- **Time Handling**: New `AstroTime` wrapper for timezone enforcement
- **Domain Purity**: No Swiss Ephemeris in domain layer

## Breaking Changes

### 1. Domain Models (Pydantic v2)

**Before (v1.2.0)**:
```python
# Models were dataclasses
from astrosdk.domain.planet import PlanetPosition

planet = PlanetPosition(...)
planet.longitude = 150.0  # Mutable
```

**After (v1.3.0)**:
```python
# Models are immutable Pydantic BaseModels
from astrosdk.domain.planet import PlanetPosition

planet = PlanetPosition(...)
# planet.longitude = 150.0  # ❌ Error: frozen model
```

**Migration**: Models are now immutable. Create new instances instead of modifying.

### 2. Time Handling

**Before (v1.2.0)**:
```python
from astrosdk.core.time import Time
from datetime import datetime, timezone

time = Time(datetime(2000, 1, 1, 12, 0, tzinfo=timezone.utc))
```

**After (v1.3.0)**:
```python
from astrosdk import AstroTime

# Recommended: from components
time = AstroTime.from_components(2000, 1, 1, 12, 0, tz="UTC")

# Or from ISO string
time = AstroTime.from_iso("2000-01-01T12:00:00Z")

# Or from datetime (must be timezone-aware)
from datetime import datetime
from zoneinfo import ZoneInfo
dt = datetime(2000, 1, 1, 12, 0, tzinfo=ZoneInfo("UTC"))
time = AstroTime(dt)
```

**Migration**: Use `AstroTime` wrapper instead of direct `Time` class.

### 3. Public API

**Before (v1.2.0)**:
```python
from astrosdk.core.ephemeris import Ephemeris
from astrosdk.services.natal_service import NatalService
from astrosdk.core.constants import HouseSystem

eph = Ephemeris()
service = NatalService(eph)
chart = service.calculate_natal_chart(
    time, 40.7, -74.0, HouseSystem.PLACIDUS
)
```

**After (v1.3.0)**:
```python
from astrosdk import calculate_natal_chart

chart = calculate_natal_chart(
    time=time,
    latitude=40.7,
    longitude=-74.0
    # house_system defaults to PLACIDUS
)
```

**Migration**: Use facade functions from `astrosdk` instead of direct service access.

### 4. Aspect Calculation

**Before (v1.2.0)**:
```python
from astrosdk.services.aspect_service import AspectService

service = AspectService()
aspects = service.calculate_aspects(positions)
```

**After (v1.3.0)**:
```python
from astrosdk import calculate_aspects

aspects = calculate_aspects(positions)

# With custom options
aspects = calculate_aspects(
    positions,
    types=['major', 'minor'],
    orbs={'CONJUNCTION': 12.0}
)
```

**Migration**: Use `calculate_aspects()` function.

## Step-by-Step Migration

### Step 1: Update Dependencies

```bash
pip install --upgrade astrosdk
```

Ensure you have Pydantic v2:
```bash
pip install "pydantic>=2.0"
```

### Step 2: Update Imports

Replace service imports with facade functions:

```python
# OLD
from astrosdk.core.ephemeris import Ephemeris
from astrosdk.services.natal_service import NatalService
from astrosdk.services.aspect_service import AspectService
from astrosdk.core.time import Time

# NEW
from astrosdk import (
    calculate_natal_chart,
    calculate_aspects,
    AstroTime
)
```

### Step 3: Update Time Creation

Replace `Time` with `AstroTime`:

```python
# OLD
from datetime import datetime, timezone
time = Time(datetime(2000, 1, 1, 12, 0, tzinfo=timezone.utc))

# NEW
time = AstroTime.from_components(2000, 1, 1, 12, 0, tz="UTC")
```

### Step 4: Update Chart Calculation

```python
# OLD
eph = Ephemeris()
service = NatalService(eph)
chart = service.calculate_natal_chart(time, lat, lon, house_system)

# NEW
chart = calculate_natal_chart(
    time=time,
    latitude=lat,
    longitude=lon,
    house_system=house_system
)
```

### Step 5: Update Aspect Calculation

```python
# OLD
aspect_service = AspectService()
aspects = aspect_service.calculate_aspects(positions)

# NEW
aspects = calculate_aspects(positions)
```

## Complete Example

### Before (v1.2.0)

```python
from datetime import datetime, timezone
from astrosdk.core.time import Time
from astrosdk.core.ephemeris import Ephemeris
from astrosdk.core.constants import Planet, HouseSystem
from astrosdk.services.natal_service import NatalService
from astrosdk.services.aspect_service import AspectService

# Setup
eph = Ephemeris()
natal_service = NatalService(eph)
aspect_service = AspectService()

# Time
time = Time(datetime(1990, 1, 1, 12, 0, tzinfo=timezone.utc))

# Chart
chart = natal_service.calculate_natal_chart(
    time, 40.7128, -74.0060, HouseSystem.PLACIDUS
)

# Aspects
aspects = aspect_service.calculate_aspects(chart.planets)

# Print
for planet in chart.planets:
    print(f"{planet.planet.name}: {planet.longitude:.2f}°")
```

### After (v1.3.0)

```python
from astrosdk import calculate_natal_chart, calculate_aspects, AstroTime

# Time
time = AstroTime.from_components(1990, 1, 1, 12, 0, tz="UTC")

# Chart
chart = calculate_natal_chart(
    time=time,
    latitude=40.7128,
    longitude=-74.0060
)

# Aspects
aspects = calculate_aspects(chart.planets)

# Print
for planet in chart.planets:
    print(f"{planet.planet.name}: {planet.longitude:.2f}°")
```

## New Features in v1.3.0

Take advantage of new capabilities:

### KP Houses
```python
from astrosdk.domain.kp_houses import calculate_kp_houses

cusps = [c.longitude for c in chart.houses.cusps]
kp = calculate_kp_houses(cusps, chart.houses.axes.ascendant, chart.houses.axes.midheaven)
```

### Event Rules
```python
from astrosdk.domain.event_rules import EventRule, RetrogradeCondition

rule = EventRule(
    name="Mercury Retrograde",
    conditions=[RetrogradeCondition(planet=Planet.MERCURY, is_retrograde=True)]
)
```

### Midpoints
```python
from astrosdk.domain.midpoints import calculate_all_midpoints

midpoints = calculate_all_midpoints(chart.planets)
```

### Harmonic Charts
```python
from astrosdk.domain.harmonics import calculate_harmonic_positions

h5 = calculate_harmonic_positions(chart.planets, 5)
```

## Troubleshooting

### "AstroTime requires timezone-aware datetime"

**Problem**: Passing naive datetime to AstroTime

**Solution**: Use `from_components()` or ensure datetime has timezone:
```python
# Good
time = AstroTime.from_components(2000, 1, 1, 12, 0, tz="UTC")

# Also good
from zoneinfo import ZoneInfo
dt = datetime(2000, 1, 1, 12, 0, tzinfo=ZoneInfo("UTC"))
time = AstroTime(dt)
```

### "Cannot assign to frozen model"

**Problem**: Trying to modify Pydantic model

**Solution**: Create new instance instead:
```python
# Bad
planet.longitude = 150.0

# Good
from pydantic import BaseModel
planet = planet.model_copy(update={'longitude': 150.0})
```

### Import Errors

**Problem**: Old imports no longer work

**Solution**: Use public API:
```python
# Instead of
from astrosdk.services.natal_service import NatalService

# Use
from astrosdk import calculate_natal_chart
```

## Getting Help

- **Documentation**: [astrosdk.dev](https://astrosdk.dev)
- **Issues**: [GitHub Issues](https://github.com/yourusername/astrosdk/issues)
- **Changelog**: [CHANGELOG.md](../about/changelog.md)
